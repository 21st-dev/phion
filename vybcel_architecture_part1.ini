sequenceDiagram
    participant U as üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant W as üåê Web App Next.js –ø–æ—Ä—Ç 3004
    participant V as üíª VSCode/Cursor —Å Extension
    participant T as üõ†Ô∏è Phion Toolbar (npm –ø–∞–∫–µ—Ç)
    participant C as üì¶ CLI Agent (npm phion)
    participant WS as üì° WebSocket Server Railway –ø–æ—Ä—Ç 8080
    participant DB as üóÉÔ∏è Supabase PostgreSQL Database
    participant APP as ü§ñ GitHub App ID 1390062
    participant GH as üêô GitHub API –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è phion
    participant N as üî• Netlify Deploy Service

    Note over U,N: üöÄ Phion PRODUCTION ARCHITECTURE - PART 1: PROJECT CREATION & SETUP

    %% === 0. PREDEFINED SETUP ===
    rect rgb(230, 230, 250)
        Note over APP,GH: 0Ô∏è‚É£ PREDEFINED SETUP - –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        
        Note over APP: GitHub App "Phion Bot" ID 1390062 —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        APP->>GH: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é phion —Å Installation ID 70719351
        Note right of APP: User access not required - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–Ω–æ–º–Ω–æ
        Note right of APP: –ü—Ä–∞–≤–∞: repo contents metadata webhooks
        
        Note over W: Backend —Ö—Ä–∞–Ω–∏—Ç private key –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        Note right of W: –ú–æ–∂–µ—Ç –ø–æ–ª—É—á–∞—Ç—å installation tokens –¥–µ–π—Å—Ç–≤—É—é—Ç 60 –º–∏–Ω—É—Ç
        Note right of W: GITHUB_APP_ID=1390062 GITHUB_APP_INSTALLATION_ID=70719351
        
        Note over U,N: üîë –ö–õ–Æ–ß–ï–í–ê–Ø –û–°–û–ë–ï–ù–ù–û–°–¢–¨ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ò–ö–û–ì–î–ê –Ω–µ –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ GitHub
    end

    %% === 1. PROJECT CREATION ===
    rect rgb(240, 248, 255)
        Note over U,N: 1Ô∏è‚É£ –°–û–ó–î–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê - WebSocket —Å–µ—Ä–≤–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        U->>W: –ó–∞—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É /dashboard –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        Note right of U: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "Create New Project"
        
        U->>W: –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "Create New Project" —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
        Note right of W: POST /api/projects –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
        
        W->>DB: ProjectQueries.createProject —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ projects
        Note right of DB: INSERT INTO projects —Å user_id name template_type
        DB-->>W: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–æ–µ–∫—Ç–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
        
        W->>WS: POST /api/projects/create-repository –≤—ã–∑—ã–≤–∞–µ—Ç WebSocket —Å–µ—Ä–≤–µ—Ä
        Note right of W: –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ GitHub —Ä–µ–ø–æ –≤ Railway (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è serverless)
        Note right of W: Next.js –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã–µ HTTP –≤—ã–∑–æ–≤—ã –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
        
        WS->>APP: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç installation token –¥–ª—è GitHub App ID 1390062
        Note right of APP: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Å private key –∏ –ø–æ–ª—É—á–∞–µ—Ç installation token
        APP->>APP: POST /app/installations/70719351/access_tokens —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω
        APP-->>WS: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç installation_token –¥–µ–π—Å—Ç–≤—É–µ—Ç 60 –º–∏–Ω—É—Ç
        
        WS->>GH: GitHub API POST /orgs/phion/repos —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        Note right of GH: –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π phion-project-{projectId}
        Note right of GH: Authorization Bearer {installation_token} + auto_init true
        GH->>GH: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å initial commit –∏ README –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ phion
        GH-->>WS: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç github_repo_url clone_url –∏ repo details
        
        WS->>DB: ProjectQueries.updateGitHubInfo –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ GitHub
        Note right of DB: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç github_repo_url github_repo_name owner phion
        
        WS-->>W: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        Note right of W: –ü–æ–ª—É—á–∞–µ—Ç github_repo_url github_repo_name –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        
        W->>DB: ProjectQueries.updateProject —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å pending
        Note right of DB: deploy_status = pending –ø–æ–∫–∞ –ø—Ä–æ–µ–∫—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
        
        W->>WS: POST /api/projects/initialize –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —à–∞–±–ª–æ–Ω–∞
        Note right of W: –ü–µ—Ä–µ–Ω–æ—Å–∏–º –∑–∞–ª–∏–≤–∫—É —à–∞–±–ª–æ–Ω–∞ –≤ Railway (–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è serverless)
        Note right of W: WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç initializeProjectInBackground –≤ —Ñ–æ–Ω–µ
        
        WS-->>W: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ –Ω–∞—á–∞–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        Note right of WS: Railway –Ω–µ –∑–∞—Å—ã–ø–∞–µ—Ç - —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
        
        W-->>U: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞—Ç—É—Å pending downloadUrl
        Note right of U: –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending + —Å—Å—ã–ª–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é)
        Note right of U: –í—Å–µ —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ Railway WebSocket —Å–µ—Ä–≤–µ—Ä
        
        par –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å initializeProjectInBackground –≤ Railway
            WS->>WS: generateTemplateFiles —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª—ã —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞
            Note right of WS: –ë–µ—Ä–µ—Ç —à–∞–±–ª–æ–Ω –∏–∑ –ø–∞–ø–∫–∏ templates/vite-react –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –µ–≥–æ
            WS->>WS: –ó–∞–º–µ–Ω—è–µ—Ç __PROJECT_ID__ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –≤ phion.config.json
            WS->>WS: –ó–∞–º–µ–Ω—è–µ—Ç __WS_URL__ –Ω–∞ URL WebSocket —Å–µ—Ä–≤–µ—Ä–∞
            
            WS->>WS: import('./services/github.js') –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç GitHub —Å–µ—Ä–≤–∏—Å–∞
            Note right of WS: Railway –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π Node.js —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
            
            WS->>GH: GitHub API GET /repos/phion/repo/git/refs/heads/main –ø–æ–ª—É—á–∞–µ—Ç parent commit
            Note right of GH: –ü–æ–ª—É—á–∞–µ—Ç SHA –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
            GH-->>WS: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç parent commit SHA –¥–ª—è tree API
            
            loop –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–∞–Ω–∫–∞–º–∏ –ø–æ 5 —à—Ç—É–∫
                WS->>GH: GitHub API POST /repos/phion/repo/git/blobs —Å–æ–∑–¥–∞–µ—Ç 5 blobs
                Note right of GH: –°–æ–∑–¥–∞–µ—Ç blob –æ–±—ä–µ–∫—Ç—ã –¥–ª—è —á–∞–Ω–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 100ms
                GH-->>WS: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SHA –¥–ª—è –∫–∞–∂–¥–æ–≥–æ blob –æ–±—ä–µ–∫—Ç–∞ –≤ —á–∞–Ω–∫–µ
            end
            
            WS->>GH: GitHub API POST /repos/phion/repo/git/trees —Å–æ–∑–¥–∞–µ—Ç tree —Å–æ –≤—Å–µ–º–∏ —Ñ–∞–π–ª–∞–º–∏
            Note right of GH: –°–æ–∑–¥–∞–µ—Ç tree –æ–±—ä–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –≤—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
            GH-->>WS: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç tree SHA
            
            WS->>GH: GitHub API POST /repos/phion/repo/git/commits —Å–æ–∑–¥–∞–µ—Ç –µ–¥–∏–Ω—ã–π –∫–æ–º–º–∏—Ç
            Note right of GH: –°–æ–∑–¥–∞–µ—Ç –æ–¥–∏–Ω –∫–æ–º–º–∏—Ç —Å–æ –≤—Å–µ–º–∏ —Ñ–∞–π–ª–∞–º–∏ —à–∞–±–ª–æ–Ω–∞ + parent commit SHA
            GH-->>WS: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç commit SHA
            
            WS->>GH: GitHub API PATCH /repos/phion/repo/git/refs/heads/main –æ–±–Ω–æ–≤–ª—è–µ—Ç main
            Note right of GH: –û–±–Ω–æ–≤–ª—è–µ—Ç main –≤–µ—Ç–∫—É –Ω–∞ –Ω–æ–≤—ã–π –∫–æ–º–º–∏—Ç
            GH-->>WS: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è main –≤–µ—Ç–∫–∏
            
            WS->>DB: CommitHistoryQueries.createCommitHistory —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å
            Note right of DB: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç commit SHA –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ commit_history
            
            WS->>DB: ProjectQueries.updateProject –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å ready
            Note right of DB: –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è —Å pending –Ω–∞ ready (–ø—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤)
            Note right of DB: Netlify —Å–∞–π—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ –ø–µ—Ä–≤–æ–º Save All Changes
            
            WS->>WS: io.to(`project_${projectId}`).emit('deploy_status_update') –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ
            Note right of WS: –ü—Ä—è–º–æ–µ WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–µ–∑ HTTP –≤—ã–∑–æ–≤–æ–≤
            Note right of WS: Railway –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–±—ã—Ç–∏–π
            
            WS->>W: WebSocket —Å–æ–±—ã—Ç–∏–µ deploy_status_update —É–≤–µ–¥–æ–º–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä
            Note right of W: UI –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è - –∫–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
            Note right of W: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é
        end
        
        alt –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –î–û –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            U->>W: –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ (deploy_status = pending)
            Note right of U: –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Initializing..." –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
            Note right of U: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ø–∏–Ω–Ω–µ—Ä –∏ —Ç–µ–∫—Å—Ç "Project is being initialized"
            Note right of U: WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            Note right of U: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–∫–∞ —Ñ–∞–π–ª—ã —à–∞–±–ª–æ–Ω–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ GitHub
            
            WS->>W: deploy_status_update —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            Note right of W: UI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            Note right of W: –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
        else –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∏–≤–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –ü–û–°–õ–ï –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            U->>W: –ö–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (deploy_status != pending)
            W->>W: GET /api/projects/projectId/download –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
            W->>GH: downloadProjectFromGitHub –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–π ZIP –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            GH-->>W: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ main –≤–µ—Ç–∫–∏ –∫–∞–∫ ZIP –∞—Ä—Ö–∏–≤
            W-->>U: –ë—Ä–∞—É–∑–µ—Ä —Å–∫–∞—á–∏–≤–∞–µ—Ç project.zip –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            Note right of U: –ü—Ä–æ–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ñ–∞–π–ª—ã —à–∞–±–ª–æ–Ω–∞ + phion –∞–≥–µ–Ω—Ç —Å PROJECT_ID + VS Code extension
        end
    end

    %% === 2. LOCAL SETUP AND AGENT CONNECTION ===
    rect rgb(250, 255, 250)
        Note over U,C: 2Ô∏è‚É£ –õ–û–ö–ê–õ–¨–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê - —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        U->>U: –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç ZIP –∞—Ä—Ö–∏–≤ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
        Note right of U: –ü–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é –ø–∞–ø–∫—É —Å package.json phion –∞–≥–µ–Ω—Ç –∏ git remote
        
        U->>V: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ VSCode –∏–ª–∏ Cursor
        Note right of V: –†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
        Note right of V: VS Code Extension –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç Phion –ø—Ä–æ–µ–∫—Ç —á–µ—Ä–µ–∑ phion.config.json
        
        V->>V: VSCode Extension –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ phion.config.json
        Note right of V: –§–∞–π–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è: templates/vite-react/scripts/auto-browser-extension/extension.js
        Note right of V: –ö–æ–º–∞–Ω–¥—ã: phion.startProject, phion.openPreview, phion.fixConnection
        Note right of V: –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: scripts/auto-browser-extension/ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞
        
        U->>U: –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        Note right of U: pnpm install —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤–∫–ª—é—á–∞—è phion
        Note right of U: phion –ø–∞–∫–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç CLI –∞–≥–µ–Ω—Ç –∏ Vite plugin —Å toolbar
        
        U->>U: –ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É pnpm start –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        Note right of U: –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ pnpm dev –∏ pnpm sync
        Note right of U: pnpm start = "pnpm install && node scripts/start-with-browser.js"
        
        par VS Code Extension –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
            V->>V: Extension –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–ø—É—Å–∫–∞–ª—Å—è –ª–∏ –ø—Ä–æ–µ–∫—Ç —Ä–∞–Ω–µ–µ —á–µ—Ä–µ–∑ context.globalState
            Note right of V: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è auto-start
            
            alt –ü–µ—Ä–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (AUTO_START_NEW_PROJECT = true)
                V->>V: Extension –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É phion.startProject
                Note right of V: –°–æ–∑–¥–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç "pnpm start"
                V->>V: markProjectAsStarted(context) –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –∫–∞–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π
                
                V->>V: startServerMonitoring() –Ω–∞—á–∏–Ω–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ localhost:5173
                Note right of V: –û–ø—Ä–∞—à–∏–≤–∞–µ—Ç dev —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –æ–∂–∏–¥–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                
                V->>V: –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç phion.openPreview
                Note right of V: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç http://localhost:5173 –≤ VS Code Simple Browser
                Note right of V: –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç workspace: –∑–∞–∫—Ä—ã–≤–∞–µ—Ç sidebar, terminal, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç AI chat
            else –ü—Ä–æ–µ–∫—Ç —É–∂–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è —Ä–∞–Ω–µ–µ
                V->>V: –¢–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞ –±–µ–∑ auto-start
                Note right of V: –£–≤–∞–∂–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            end
        end
        
        par CLI Agent –∑–∞–ø—É—Å–∫
            C->>C: Phion CLI –∞–≥–µ–Ω—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π pnpm sync (–∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç "phion")
            Note right of C: CLI —Ñ–∞–π–ª: packages/dev-agent/src/cli.ts —Å bin –∫–æ–º–∞–Ω–¥–æ–π
            Note right of C: –ß–∏—Ç–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ phion.config.json
            Note right of C: npm –ø–∞–∫–µ—Ç "phion" –≤–µ—Ä—Å–∏–∏ latest —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ
            
            C->>C: checkGitRepository –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            Note right of C: –ï—Å–ª–∏ .git –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            
            alt Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω
                C->>C: initializeGitRepository –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç git
                Note right of C: git init + remote add origin –∫ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
                C->>C: –°–æ–∑–¥–∞–µ—Ç initial commit —Å —Ç–µ–∫—É—â–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏
                Note right of C: git add . && git commit -m "Initial commit from template"
            else Git —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
                C->>C: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç remote origin
                Note right of C: –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º remote
            end
            
            C->>WS: WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ws://localhost:8080/ –∏–ª–∏ production URL
            Note right of C: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –æ–±–ª–∞—á–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º
            Note right of C: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            Note right of C: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–≤—è–∑–∏
            
            C->>WS: emit authenticate –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç projectId –∏ clientType agent
            Note right of C: –ê–≥–µ–Ω—Ç —Å–æ–æ–±—â–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä—É –∫ –∫–∞–∫–æ–º—É –ø—Ä–æ–µ–∫—Ç—É –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è
            
            WS->>WS: socket.on authenticate –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ index.ts
            Note right of WS: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç—É –ø—Ä–æ–µ–∫—Ç–∞
            
            WS->>DB: ProjectQueries.getProjectById –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤–∫–ª—é—á–∞—è GitHub repo
            Note right of DB: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç github_repo_url github_repo_name owner –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            DB-->>WS: –û–±—ä–µ–∫—Ç –ø—Ä–æ–µ–∫—Ç–∞ —Å github_repo_url deploy_status created_at
            
            WS->>WS: socket.join –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç—É project projectId
            Note right of WS: –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            
            WS->>WS: connectedAgents.set —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç socketId –∞–≥–µ–Ω—Ç–∞
            Note right of WS: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            
            WS-->>C: emit authenticated –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
            Note right of C: –ê–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
            
            WS->>W: io.to broadcast –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç agent_connected –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º –ø—Ä–æ–µ–∫—Ç–∞
            Note right of W: –ë—Ä–∞—É–∑–µ—Ä –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞
            
            W->>W: UI –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞ –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ
            Note right of W: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–µ–ª–µ–Ω—É—é –≥–∞–ª–æ—á–∫—É "Connected!" –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫—É
            Note right of W: –ù–û –ù–ï –î–ï–õ–ê–ï–¢ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç - –∂–¥–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
            C->>C: startFileWatcher –∑–∞–ø—É—Å–∫–∞–µ—Ç chokidar.watch —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            Note right of C: –ù–∞—á–∏–Ω–∞–µ—Ç —Å–ª–µ–¥–∏—Ç—å –∑–∞ –≤—Å–µ–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∫—Ä–æ–º–µ node_modules .git dist
            Note right of C: packages/dev-agent/src/agent.ts - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –∞–≥–µ–Ω—Ç–∞
        end
        
        par Toolbar –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
            T->>T: Toolbar –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            Note right of T: Vite plugin –∏–∑ npm –ø–∞–∫–µ—Ç–∞ phion –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω–µ–¥—Ä—è–µ—Ç toolbar
            Note right of T: –ù–ï–¢ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è - toolbar —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ npm
            Note right of T: packages/dev-agent/src/plugin.ts –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç toolbar –∏–∑ npm –ø–∞–∫–µ—Ç–∞
            
            T->>WS: WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
            Note right of T: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞
            T->>WS: emit toolbar_get_status –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PROJECT_ID
            
            WS->>WS: –î–æ–±–∞–≤–ª—è–µ—Ç toolbar –≤ –∫–æ–º–Ω–∞—Ç—É –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            WS->>DB: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –∏ pending changes
            WS-->>T: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
            
            T->>T: –û–±–Ω–æ–≤–ª—è–µ—Ç UI –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            Note right of T: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ pending changes –∏ —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
            Note right of T: –ö–Ω–æ–ø–∫–∏ Save All –∏ Discard All —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            Note right of T: packages/dev-agent/src/toolbar/Toolbar.tsx - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        end
        
        alt –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É
            U->>W: –í–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å "Connected!" –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "Continue to Development"
            Note right of U: –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞
            
            W->>W: handleSetupComplete –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ overview
            Note right of W: router.push(`/project/${project.id}/overview`)
            
            W-->>U: –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Overview –ø—Ä–æ–µ–∫—Ç–∞
            Note right of U: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–µ–∫—Ç–æ–º
        else –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ –¥—Ä—É–≥–æ–π —Å—Å—ã–ª–∫–µ
            Note right of U: –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã
            Note right of U: –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞—Ö–æ–¥–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ overview
        end
    end

    %% === 3. FILE EDITING AND STAGING ===
    rect rgb(255, 250, 240)
        Note over V,DB: 3Ô∏è‚É£ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ø–∞–¥–∞—é—Ç –≤ staging area pending_changes
        
        loop –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
            U->>V: –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –Ω–∞–ø—Ä–∏–º–µ—Ä src/App.tsx –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
            Note right of V: –í–Ω–æ—Å–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∏–ª–∏ —Å—Ç–∏–ª–∏
            
            V->>V: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Ctrl+S –∏–ª–∏ Cmd+S –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            Note right of V: –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
            
            V->>C: chokidar –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ src/App.tsx
            Note right of C: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ chokidar –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
            
            C->>C: –ß–∏—Ç–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ —Å –ø–æ–º–æ—â—å—é fs.readFileSync
            Note right of C: –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            
            C->>WS: emit file_change –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            Note right of C: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç file_path –Ω–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ action modified
            
            WS->>WS: socket.on file_change –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            Note right of WS: –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
            
            WS->>DB: PendingChangesQueries.upsertPendingChange —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ staging area
            Note right of DB: UPSERT INTO pending_changes —Å –ø–æ–ª–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Ñ–∞–π–ª–∞
            DB->>DB: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç project_id file_path content action modified timestamp
            
            WS->>W: io.to projectId emit file_change_staged —É–≤–µ–¥–æ–º–ª—è–µ—Ç –í–°–ï –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
            Note right of W: –ë—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ staging area
            WS->>T: WebSocket —Å–æ–±—ã—Ç–∏–µ pending_changes_updated —É–≤–µ–¥–æ–º–ª—è–µ—Ç toolbar
            Note right of T: Toolbar –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            
            W->>W: UI –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            Note right of W: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "3 –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è" –∏ –∫–Ω–æ–ø–∫–∏ Save All / Discard All
            T->>T: –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ toolbar
            Note right of T: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "3 –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è" –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        end
    end

    Note over U,N: ‚û°Ô∏è –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –í–û –í–¢–û–†–û–ô –ß–ê–°–¢–ò: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –¥–µ–ø–ª–æ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º 