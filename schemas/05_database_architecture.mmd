sequenceDiagram
    participant APP as ðŸŒ Web App
    participant CLIENT as ðŸ’¾ Supabase Client
    participant AUTH as ðŸ” Supabase Auth
    participant DB as ðŸ—ƒï¸ PostgreSQL
    participant RLS as ðŸ›¡ï¸ Row Level Security
    participant REALTIME as âš¡ Realtime Engine
    participant QUERIES as ðŸ“‹ Query Layer

    Note over APP,QUERIES: ðŸ—ƒï¸ DATABASE (Supabase) - Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐÐ¯ ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð

    %% === Ð¡Ð¥Ð•ÐœÐ Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥ ===
    rect rgb(250, 240, 255)
        Note over DB: ðŸ“Š Ð¡Ð¥Ð•ÐœÐ Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥
        
        Note left of DB: ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð«
        Note left of DB: â”œâ”€â”€ auth.users (Supabase Auth)
        Note left of DB: â”‚   â”œâ”€â”€ id (uuid, primary)
        Note left of DB: â”‚   â”œâ”€â”€ email (varchar, unique)
        Note left of DB: â”‚   â”œâ”€â”€ encrypted_password
        Note left of DB: â”‚   â”œâ”€â”€ email_confirmed_at
        Note left of DB: â”‚   â”œâ”€â”€ created_at, updated_at
        Note left of DB: â”‚   â””â”€â”€ raw_user_meta_data (jsonb)
        Note left of DB: â”œâ”€â”€ public.projects
        Note left of DB: â”‚   â”œâ”€â”€ id (uuid, primary, default: gen_random_uuid())
        Note left of DB: â”‚   â”œâ”€â”€ user_id (uuid, foreign â†’ auth.users.id)
        Note left of DB: â”‚   â”œâ”€â”€ name (varchar(255), not null)
        Note left of DB: â”‚   â”œâ”€â”€ description (text)
        Note left of DB: â”‚   â”œâ”€â”€ template_type (varchar(50), default: 'vite-react')
        Note left of DB: â”‚   â”œâ”€â”€ github_repo_url (varchar(500))
        Note left of DB: â”‚   â”œâ”€â”€ github_repo_name (varchar(255))
        Note left of DB: â”‚   â”œâ”€â”€ netlify_site_id (varchar(255))
        Note left of DB: â”‚   â”œâ”€â”€ netlify_url (varchar(500))
        Note left of DB: â”‚   â”œâ”€â”€ deploy_status (varchar(50), default: 'pending')
        Note left of DB: â”‚   â”œâ”€â”€ is_deleted (boolean, default: false)
        Note left of DB: â”‚   â”œâ”€â”€ created_at (timestamptz, default: now())
        Note left of DB: â”‚   â””â”€â”€ updated_at (timestamptz, default: now())

        Note right of DB: Ð”ÐžÐŸÐžÐ›ÐÐ˜Ð¢Ð•Ð›Ð¬ÐÐ«Ð• Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð«
        Note right of DB: â”œâ”€â”€ public.file_history
        Note right of DB: â”‚   â”œâ”€â”€ id (uuid, primary)
        Note right of DB: â”‚   â”œâ”€â”€ project_id (uuid, foreign â†’ projects.id)
        Note right of DB: â”‚   â”œâ”€â”€ file_path (varchar(500), not null)
        Note right of DB: â”‚   â”œâ”€â”€ content (text)
        Note right of DB: â”‚   â”œâ”€â”€ content_hash (varchar(64))
        Note right of DB: â”‚   â”œâ”€â”€ action (varchar(20)) -- created/modified/deleted
        Note right of DB: â”‚   â”œâ”€â”€ file_size (integer)
        Note right of DB: â”‚   â”œâ”€â”€ mime_type (varchar(100))
        Note right of DB: â”‚   â”œâ”€â”€ version_number (integer, default: 1)
        Note right of DB: â”‚   â”œâ”€â”€ created_at (timestamptz, default: now())
        Note right of DB: â”‚   â””â”€â”€ INDEX ON (project_id, file_path, created_at)
        Note right of DB: â”œâ”€â”€ public.commit_history
        Note right of DB: â”‚   â”œâ”€â”€ id (uuid, primary)
        Note right of DB: â”‚   â”œâ”€â”€ project_id (uuid, foreign â†’ projects.id)
        Note right of DB: â”‚   â”œâ”€â”€ github_commit_sha (varchar(40))
        Note right of DB: â”‚   â”œâ”€â”€ github_commit_url (varchar(500))
        Note right of DB: â”‚   â”œâ”€â”€ commit_message (text)
        Note right of DB: â”‚   â”œâ”€â”€ file_count (integer, default: 0)
        Note right of DB: â”‚   â”œâ”€â”€ changes_summary (jsonb)
        Note right of DB: â”‚   â”œâ”€â”€ created_at (timestamptz, default: now())
        Note right of DB: â”‚   â””â”€â”€ INDEX ON (project_id, created_at DESC)
        Note right of DB: â””â”€â”€ public.pending_changes
        Note right of DB:     â”œâ”€â”€ id (uuid, primary)
        Note right of DB:     â”œâ”€â”€ project_id (uuid, foreign â†’ projects.id)
        Note right of DB:     â”œâ”€â”€ file_path (varchar(500), not null)
        Note right of DB:     â”œâ”€â”€ content (text)
        Note right of DB:     â”œâ”€â”€ action (varchar(20)) -- modified/created/deleted
        Note right of DB:     â”œâ”€â”€ content_hash (varchar(64))
        Note right of DB:     â”œâ”€â”€ created_at (timestamptz, default: now())
        Note right of DB:     â”œâ”€â”€ updated_at (timestamptz, default: now())
        Note right of DB:     â”œâ”€â”€ UNIQUE (project_id, file_path)
        Note right of DB:     â””â”€â”€ INDEX ON (project_id, updated_at DESC)
    end

    %% === ROW LEVEL SECURITY ===
    rect rgb(255, 245, 245)
        Note over RLS: ðŸ›¡ï¸ ROW LEVEL SECURITY (RLS)
        
        Note left of RLS: RLS ÐŸÐžÐ›Ð˜Ð¢Ð˜ÐšÐ˜
        Note left of RLS: â”œâ”€â”€ projects table:
        Note left of RLS: â”‚   â”œâ”€â”€ SELECT: user_id = auth.uid()
        Note left of RLS: â”‚   â”œâ”€â”€ INSERT: user_id = auth.uid()
        Note left of RLS: â”‚   â”œâ”€â”€ UPDATE: user_id = auth.uid()
        Note left of RLS: â”‚   â””â”€â”€ DELETE: user_id = auth.uid()
        Note left of RLS: â”œâ”€â”€ file_history table:
        Note left of RLS: â”‚   â”œâ”€â”€ SELECT: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS: â”‚   â”œâ”€â”€ INSERT: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS: â”‚   â””â”€â”€ DELETE: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS: â”œâ”€â”€ commit_history table:
        Note left of RLS: â”‚   â”œâ”€â”€ SELECT: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS: â”‚   â””â”€â”€ INSERT: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS: â””â”€â”€ pending_changes table:
        Note left of RLS:     â”œâ”€â”€ SELECT: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS:     â”œâ”€â”€ INSERT: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS:     â”œâ”€â”€ UPDATE: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())
        Note left of RLS:     â””â”€â”€ DELETE: project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())

        Note right of RLS: Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ¡Ð¢Ð¬ Ð˜ Ð˜Ð—ÐžÐ›Ð¯Ð¦Ð˜Ð¯
        Note right of RLS: â”œâ”€â”€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð·Ð¾Ð»ÑÑ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼
        Note right of RLS: â”œâ”€â”€ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð½ÐµÑÐ°Ð½ÐºÑ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
        Note right of RLS: â”œâ”€â”€ Query-level security enforcement
        Note right of RLS: â”œâ”€â”€ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        Note right of RLS: â””â”€â”€ Audit trail Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹

        alt ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ
            CLIENT->>RLS: SELECT * FROM projects WHERE id = ?
            RLS->>AUTH: auth.uid() Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
            AUTH-->>RLS: Current user ID
            RLS->>DB: Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾ user_id = auth.uid()
            DB-->>CLIENT: Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        end
        
        alt ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ‡ÑƒÐ¶Ð¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ð¼
            CLIENT->>RLS: SELECT * FROM file_history WHERE project_id = ?
            RLS->>RLS: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ownership Ñ‡ÐµÑ€ÐµÐ· projects table
            RLS->>DB: Subquery Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð°
            alt ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
                RLS-->>CLIENT: ÐŸÑƒÑÑ‚Ð¾Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ (Ð½ÐµÑ‚ Ð¾ÑˆÐ¸Ð±ÐºÐ¸)
            else ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ†
                RLS->>DB: Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…
                DB-->>CLIENT: File history Ð´Ð°Ð½Ð½Ñ‹Ðµ
            end
        end
    end

    %% === SUPABASE CLIENT ===
    rect rgb(240, 248, 255)
        Note over CLIENT: ðŸ’¾ SUPABASE CLIENT Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯
        
        Note left of CLIENT: CLIENT ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯
        Note left of CLIENT: â”œâ”€â”€ @supabase/supabase-js
        Note left of CLIENT: â”œâ”€â”€ URL: NEXT_PUBLIC_SUPABASE_URL
        Note left of CLIENT: â”œâ”€â”€ Anon Key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        Note left of CLIENT: â”œâ”€â”€ Auto refresh tokens
        Note left of CLIENT: â”œâ”€â”€ Real-time subscriptions
        Note left of CLIENT: â””â”€â”€ TypeScript support

        Note right of CLIENT: ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐœÐ•Ð¢ÐžÐ”Ð«
        Note right of CLIENT: â”œâ”€â”€ supabase.from('table_name')
        Note right of CLIENT: â”‚   â”œâ”€â”€ .select() - Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
        Note right of CLIENT: â”‚   â”œâ”€â”€ .insert() - ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ
        Note right of CLIENT: â”‚   â”œâ”€â”€ .update() - Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
        Note right of CLIENT: â”‚   â”œâ”€â”€ .delete() - ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ
        Note right of CLIENT: â”‚   â””â”€â”€ .upsert() - insert or update
        Note right of CLIENT: â”œâ”€â”€ supabase.auth
        Note right of CLIENT: â”‚   â”œâ”€â”€ .signUp() - Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ
        Note right of CLIENT: â”‚   â”œâ”€â”€ .signInWithPassword() - Ð²Ñ…Ð¾Ð´
        Note right of CLIENT: â”‚   â”œâ”€â”€ .signOut() - Ð²Ñ‹Ñ…Ð¾Ð´
        Note right of CLIENT: â”‚   â””â”€â”€ .getSession() - Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ ÑÐµÑÑÐ¸Ñ
        Note right of CLIENT: â””â”€â”€ supabase.channel()
        Note right of CLIENT:     â”œâ”€â”€ .on('postgres_changes') - Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
        Note right of CLIENT:     â””â”€â”€ .subscribe() - Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ

        alt Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            APP->>CLIENT: createClient(url, anonKey)
            CLIENT->>CLIENT: Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
            CLIENT->>AUTH: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÑÐµÑÑÐ¸Ð¸
            AUTH-->>CLIENT: Session Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð»Ð¸ null
            CLIENT-->>APP: Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ client instance
        end
        
        alt CRUD Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
            APP->>CLIENT: supabase.from('projects').select()
            CLIENT->>RLS: ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº
            RLS->>DB: Filtered query execution
            DB-->>CLIENT: Query results
            CLIENT-->>APP: Typed Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
        end
    end

    %% === AUTHENTICATION ===
    rect rgb(255, 250, 240)
        Note over AUTH: ðŸ” SUPABASE AUTHENTICATION
        
        Note left of AUTH: AUTH ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯
        Note left of AUTH: â”œâ”€â”€ JWT Ñ‚Ð¾ÐºÐµÐ½Ñ‹ (access + refresh)
        Note left of AUTH: â”œâ”€â”€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
        Note left of AUTH: â”œâ”€â”€ Email/Password Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€
        Note left of AUTH: â”œâ”€â”€ OAuth Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ñ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
        Note left of AUTH: â”œâ”€â”€ Email Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
        Note left of AUTH: â”œâ”€â”€ Password reset
        Note left of AUTH: â””â”€â”€ User metadata Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°

        Note right of AUTH: Ð–Ð˜Ð—ÐÐ•ÐÐÐ«Ð™ Ð¦Ð˜ÐšÐ› Ð¡Ð•Ð¡Ð¡Ð˜Ð˜
        Note right of AUTH: â”œâ”€â”€ Registration â†’ Email confirmation
        Note right of AUTH: â”œâ”€â”€ Login â†’ JWT token generation
        Note right of AUTH: â”œâ”€â”€ Token refresh (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)
        Note right of AUTH: â”œâ”€â”€ Session persistence (localStorage)
        Note right of AUTH: â”œâ”€â”€ Logout â†’ Token invalidation
        Note right of AUTH: â””â”€â”€ Session expiration handling

        alt Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            APP->>AUTH: signUp({email, password})
            AUTH->>DB: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² auth.users
            DB->>AUTH: User record created
            AUTH->>AUTH: ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° confirmation email
            AUTH-->>APP: {user, session: null}
            APP->>APP: Redirect Ð½Ð° confirmation page
        end
        
        alt Ð’Ñ…Ð¾Ð´ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
            APP->>AUTH: signInWithPassword({email, password})
            AUTH->>DB: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° credentials
            DB-->>AUTH: User validation result
            AUTH->>AUTH: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ JWT tokens
            AUTH-->>APP: {user, session: {access_token, refresh_token}}
            APP->>APP: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ session + redirect
        end
        
        alt ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð°
            AUTH->>AUTH: Token expiration check
            AUTH->>AUTH: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ refresh_token
            AUTH->>DB: Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ refresh token
            DB-->>AUTH: Token validation result
            AUTH->>AUTH: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ access_token
            AUTH-->>CLIENT: Updated session
        end
    end

    %% === QUERY LAYER ===
    rect rgb(245, 255, 245)
        Note over QUERIES: ðŸ“‹ QUERY LAYER Ð˜ ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—ÐÐ¦Ð˜Ð¯
        
        Note left of QUERIES: ÐžÐ Ð“ÐÐÐ˜Ð—ÐÐ¦Ð˜Ð¯ Ð—ÐÐŸÐ ÐžÐ¡ÐžÐ’
        Note left of QUERIES: â”œâ”€â”€ packages/database/
        Note left of QUERIES: â”‚   â”œâ”€â”€ src/
        Note left of QUERIES: â”‚   â”‚   â”œâ”€â”€ client.ts (Supabase client)
        Note left of QUERIES: â”‚   â”‚   â”œâ”€â”€ types.ts (Database types)
        Note left of QUERIES: â”‚   â”‚   â””â”€â”€ queries/
        Note left of QUERIES: â”‚   â”‚       â”œâ”€â”€ ProjectQueries.ts
        Note left of QUERIES: â”‚   â”‚       â”œâ”€â”€ FileHistoryQueries.ts
        Note left of QUERIES: â”‚   â”‚       â”œâ”€â”€ CommitHistoryQueries.ts
        Note left of QUERIES: â”‚   â”‚       â””â”€â”€ PendingChangesQueries.ts
        Note left of QUERIES: â”‚   â””â”€â”€ package.json
        Note left of QUERIES: â”œâ”€â”€ TypeScript ÑÑ‚Ñ€Ð¾Ð³Ð°Ñ Ñ‚Ð¸Ð¿Ð¸Ð·Ð°Ñ†Ð¸Ñ
        Note left of QUERIES: â”œâ”€â”€ Error handling wrapper
        Note left of QUERIES: â””â”€â”€ Query result validation

        Note right of QUERIES: ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—ÐÐ¦Ð˜Ð¯ Ð—ÐÐŸÐ ÐžÐ¡ÐžÐ’
        Note right of QUERIES: â”œâ”€â”€ SELECT Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ)
        Note right of QUERIES: â”œâ”€â”€ Indexes Ð½Ð° Ñ‡Ð°ÑÑ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¿Ð¾Ð»Ñ
        Note right of QUERIES: â”œâ”€â”€ Batch operations Ð´Ð»Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
        Note right of QUERIES: â”œâ”€â”€ Connection pooling (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)
        Note right of QUERIES: â”œâ”€â”€ Query caching ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸
        Note right of QUERIES: â””â”€â”€ Pagination Ð´Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²

        Note over QUERIES: ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐžÐ¡ÐÐžÐ’ÐÐ«Ð¥ Ð—ÐÐŸÐ ÐžÐ¡ÐžÐ’
        Note over QUERIES: â”œâ”€â”€ getProjectById(id: string)
        Note over QUERIES: â”œâ”€â”€ createProject(data: ProjectInsert)
        Note over QUERIES: â”œâ”€â”€ updateProject(id: string, updates: ProjectUpdate)
        Note over QUERIES: â”œâ”€â”€ getAllPendingChanges(projectId: string)
        Note over QUERIES: â”œâ”€â”€ upsertPendingChange(data: PendingChangeUpsert)
        Note over QUERIES: â”œâ”€â”€ clearAllPendingChanges(projectId: string)
        Note over QUERIES: â”œâ”€â”€ createCommitHistory(data: CommitHistoryInsert)
        Note over QUERIES: â””â”€â”€ getCommitHistory(projectId: string, limit?: number)

        alt Ð¢Ð¸Ð¿Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
            APP->>QUERIES: ProjectQueries.getProjectById(id)
            QUERIES->>CLIENT: supabase.from('projects').select().eq('id', id).single()
            CLIENT->>DB: SQL: SELECT * FROM projects WHERE id = ? AND user_id = auth.uid()
            DB-->>CLIENT: Project record Ð¸Ð»Ð¸ null
            CLIENT-->>QUERIES: Typed Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
            QUERIES-->>APP: Project | null
        end
        
        alt Batch Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
            APP->>QUERIES: PendingChangesQueries.upsertMultiple(changes)
            QUERIES->>CLIENT: supabase.from('pending_changes').upsert(changes)
            CLIENT->>DB: UPSERT multiple records
            DB-->>CLIENT: Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
            CLIENT-->>QUERIES: Success/error response
            QUERIES-->>APP: ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
        end
    end

    %% === REALTIME SUBSCRIPTIONS ===
    rect rgb(255, 245, 250)
        Note over REALTIME: âš¡ REALTIME SUBSCRIPTIONS
        
        Note left of REALTIME: REALTIME ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯
        Note left of REALTIME: â”œâ”€â”€ WebSocket ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ
        Note left of REALTIME: â”œâ”€â”€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿ÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
        Note left of REALTIME: â”œâ”€â”€ Channel management
        Note left of REALTIME: â”œâ”€â”€ Event filtering
        Note left of REALTIME: â””â”€â”€ Security Ñ‡ÐµÑ€ÐµÐ· RLS

        Note right of REALTIME: Ð¢Ð˜ÐŸÐ« Ð¡ÐžÐ‘Ð«Ð¢Ð˜Ð™
        Note right of REALTIME: â”œâ”€â”€ INSERT - Ð½Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
        Note right of REALTIME: â”œâ”€â”€ UPDATE - Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
        Note right of REALTIME: â”œâ”€â”€ DELETE - ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
        Note right of REALTIME: â”œâ”€â”€ Table-level subscriptions
        Note right of REALTIME: â””â”€â”€ Row-level filtering

        alt ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° Ð½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            APP->>REALTIME: supabase.channel('project-changes')
            REALTIME->>REALTIME: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ WebSocket channel
            APP->>REALTIME: .on('postgres_changes', {table: 'projects'})
            REALTIME->>DB: Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ subscription
            APP->>REALTIME: .subscribe()
            REALTIME-->>APP: Subscription active
        end
        
        alt Real-time Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
            DB->>REALTIME: UPDATE projects SET deploy_status = 'ready'
            REALTIME->>RLS: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            RLS-->>REALTIME: User authorized for this record
            REALTIME->>APP: {eventType: 'UPDATE', new: {...}, old: {...}}
            APP->>APP: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ UI ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
        end
    end

    %% === Ð˜ÐÐ”Ð•ÐšÐ¡Ð« Ð˜ ÐŸÐ ÐžÐ˜Ð—Ð’ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð¬ ===
    rect rgb(250, 255, 245)
        Note over DB: ðŸš€ Ð˜ÐÐ”Ð•ÐšÐ¡Ð« Ð˜ ÐŸÐ ÐžÐ˜Ð—Ð’ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð¬
        
        Note left of DB: ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• Ð˜ÐÐ”Ð•ÐšÐ¡Ð«
        Note left of DB: â”œâ”€â”€ projects table:
        Note left of DB: â”‚   â”œâ”€â”€ PRIMARY KEY (id)
        Note left of DB: â”‚   â”œâ”€â”€ INDEX ON (user_id) - Ð´Ð»Ñ RLS
        Note left of DB: â”‚   â”œâ”€â”€ INDEX ON (created_at DESC) - ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ°
        Note left of DB: â”‚   â””â”€â”€ INDEX ON (deploy_status) - Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ
        Note left of DB: â”œâ”€â”€ file_history table:
        Note left of DB: â”‚   â”œâ”€â”€ PRIMARY KEY (id)
        Note left of DB: â”‚   â”œâ”€â”€ INDEX ON (project_id, file_path) - Ð¿Ð¾Ð¸ÑÐº Ñ„Ð°Ð¹Ð»Ð¾Ð²
        Note left of DB: â”‚   â”œâ”€â”€ INDEX ON (project_id, created_at DESC) - Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ
        Note left of DB: â”‚   â””â”€â”€ INDEX ON (content_hash) - Ð´ÐµÐ´ÑƒÐ¿Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ
        Note left of DB: â”œâ”€â”€ commit_history table:
        Note left of DB: â”‚   â”œâ”€â”€ PRIMARY KEY (id)
        Note left of DB: â”‚   â”œâ”€â”€ INDEX ON (project_id, created_at DESC) - Ñ…Ñ€Ð¾Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ
        Note left of DB: â”‚   â””â”€â”€ INDEX ON (github_commit_sha) - GitHub sync
        Note left of DB: â””â”€â”€ pending_changes table:
        Note left of DB:     â”œâ”€â”€ PRIMARY KEY (id)
        Note left of DB:     â”œâ”€â”€ UNIQUE INDEX (project_id, file_path) - no duplicates
        Note left of DB:     â””â”€â”€ INDEX ON (project_id, updated_at DESC) - latest changes

        Note right of DB: ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—ÐÐ¦Ð˜Ð˜ ÐŸÐ ÐžÐ˜Ð—Ð’ÐžÐ”Ð˜Ð¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð˜
        Note right of DB: â”œâ”€â”€ Connection pooling (managed by Supabase)
        Note right of DB: â”œâ”€â”€ Query optimization (EXPLAIN ANALYZE)
        Note right of DB: â”œâ”€â”€ Prepared statements (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)
        Note right of DB: â”œâ”€â”€ Partial indexes Ð´Ð»Ñ filtered queries
        Note right of DB: â”œâ”€â”€ VACUUM Ð¸ ANALYZE (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)
        Note right of DB: â””â”€â”€ Read replicas Ð´Ð»Ñ scaling (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)

        alt ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
            QUERIES->>DB: EXPLAIN ANALYZE SELECT * FROM projects WHERE user_id = ?
            DB->>DB: Query plan analysis
            DB-->>QUERIES: Execution plan + timing
            QUERIES->>QUERIES: Performance metrics logging
        end
    end

    %% === BACKUP Ð˜ Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ===
    rect rgb(255, 255, 245)
        Note over DB: ðŸ’¾ BACKUP Ð˜ DISASTER RECOVERY
        
        Note left of DB: BACKUP Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯
        Note left of DB: â”œâ”€â”€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ daily backups (Supabase)
        Note left of DB: â”œâ”€â”€ Point-in-time recovery (PITR)
        Note left of DB: â”œâ”€â”€ Cross-region replication
        Note left of DB: â”œâ”€â”€ Manual backup triggers
        Note left of DB: â””â”€â”€ Backup retention policies

        Note right of DB: ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“ Ð˜ ÐÐ›Ð•Ð Ð¢Ð«
        Note right of DB: â”œâ”€â”€ Database connection monitoring
        Note right of DB: â”œâ”€â”€ Query performance metrics
        Note right of DB: â”œâ”€â”€ Storage usage tracking
        Note right of DB: â”œâ”€â”€ Error rate monitoring
        Note right of DB: â””â”€â”€ Automated alerts setup

        alt Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ð¹ backup
            DB->>DB: Daily automated backup
            DB->>DB: Backup compression Ð¸ encryption
            DB->>DB: Upload to secure storage
            DB->>DB: Retention policy enforcement
        end
    end

    %% === ÐœÐ˜Ð“Ð ÐÐ¦Ð˜Ð˜ Ð˜ Ð’Ð•Ð Ð¡Ð˜ÐžÐÐ˜Ð ÐžÐ’ÐÐÐ˜Ð• ===
    rect rgb(245, 245, 255)
        Note over DB: ðŸ”„ DATABASE MIGRATIONS
        
        Note left of DB: Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ ÐœÐ˜Ð“Ð ÐÐ¦Ð˜Ð™
        Note left of DB: â”œâ”€â”€ supabase/migrations/ Ð¿Ð°Ð¿ÐºÐ°
        Note left of DB: â”œâ”€â”€ SQL migration Ñ„Ð°Ð¹Ð»Ñ‹
        Note left of DB: â”œâ”€â”€ Versioned schema changes
        Note left of DB: â”œâ”€â”€ Rollback capabilities
        Note left of DB: â””â”€â”€ Environment sync (dev/staging/prod)

        Note right of DB: ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐœÐ˜Ð“Ð ÐÐ¦Ð˜Ð™
        Note right of DB: â”œâ”€â”€ 001_initial_schema.sql
        Note right of DB: â”œâ”€â”€ 002_add_projects_table.sql
        Note right of DB: â”œâ”€â”€ 003_add_rls_policies.sql
        Note right of DB: â”œâ”€â”€ 004_add_indexes.sql
        Note right of DB: â””â”€â”€ 005_add_pending_changes_table.sql

        alt ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
            DB->>DB: supabase db push
            DB->>DB: Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… migration Ñ„Ð°Ð¹Ð»Ð¾Ð²
            DB->>DB: Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ SQL commands
            DB->>DB: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ migration history
            DB-->>APP: Schema updated
        end
    end