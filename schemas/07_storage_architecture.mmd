sequenceDiagram
    participant WEB as ðŸŒ Web App
    participant STORAGE_CLIENT as ðŸ’¾ Storage Client
    participant R2_API as â˜ï¸ R2 API
    participant R2_BUCKET as ðŸª£ R2 Bucket
    participant CDN as ðŸŒ Cloudflare CDN
    participant ADMIN as ðŸ‘¨â€ðŸ’¼ Admin Interface
    participant TOOLBAR as ðŸ› ï¸ Toolbar System

    Note over WEB,TOOLBAR: â˜ï¸ STORAGE (Cloudflare R2) - Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐÐ¯ ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð

    %% === R2 STORAGE Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ===
    rect rgb(250, 245, 255)
        Note over R2_BUCKET: ðŸª£ R2 BUCKET Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð
        
        Note left of R2_BUCKET: ÐžÐ¡ÐÐžÐ’ÐÐÐ¯ Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð BUCKET
        Note left of R2_BUCKET: â”œâ”€â”€ vybcel-storage/
        Note left of R2_BUCKET: â”‚   â”œâ”€â”€ toolbar-versions/
        Note left of R2_BUCKET: â”‚   â”‚   â”œâ”€â”€ 0.1.0/
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â”œâ”€â”€ stable/
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ toolbar.zip
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â”‚   â””â”€â”€ metadata.json
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â”œâ”€â”€ beta/
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ toolbar.zip
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â”‚   â””â”€â”€ metadata.json
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â””â”€â”€ dev/
        Note left of R2_BUCKET: â”‚   â”‚   â”‚       â”œâ”€â”€ toolbar.zip
        Note left of R2_BUCKET: â”‚   â”‚   â”‚       â””â”€â”€ metadata.json
        Note left of R2_BUCKET: â”‚   â”‚   â”œâ”€â”€ 0.2.0/
        Note left of R2_BUCKET: â”‚   â”‚   â””â”€â”€ latest/
        Note left of R2_BUCKET: â”‚   â”‚       â”œâ”€â”€ metadata.json
        Note left of R2_BUCKET: â”‚   â”‚       â””â”€â”€ channels.json
        Note left of R2_BUCKET: â”‚   â”œâ”€â”€ project-templates/
        Note left of R2_BUCKET: â”‚   â”‚   â”œâ”€â”€ vite-react/
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â”œâ”€â”€ template.zip
        Note left of R2_BUCKET: â”‚   â”‚   â”‚   â””â”€â”€ template-metadata.json
        Note left of R2_BUCKET: â”‚   â”‚   â””â”€â”€ future-templates/
        Note left of R2_BUCKET: â”‚   â”œâ”€â”€ project-backups/
        Note left of R2_BUCKET: â”‚   â”‚   â””â”€â”€ {projectId}/
        Note left of R2_BUCKET: â”‚   â”‚       â”œâ”€â”€ snapshots/
        Note left of R2_BUCKET: â”‚   â”‚       â””â”€â”€ incremental/
        Note left of R2_BUCKET: â”‚   â””â”€â”€ checksums/
        Note left of R2_BUCKET: â”‚       â”œâ”€â”€ toolbar/
        Note left of R2_BUCKET: â”‚       â””â”€â”€ templates/

        Note right of R2_BUCKET: METADATA Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð«
        Note right of R2_BUCKET: â”œâ”€â”€ toolbar metadata.json:
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ version (semver)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ releaseNotes (string)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ forceUpdate (boolean)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ minClientVersion (semver)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ fileSize (bytes)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ checksum (SHA-256)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ uploadedAt (ISO timestamp)
        Note right of R2_BUCKET: â”‚   â””â”€â”€ downloadCount (number)
        Note right of R2_BUCKET: â”œâ”€â”€ channels.json:
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ stable (latest stable version)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ beta (latest beta version)
        Note right of R2_BUCKET: â”‚   â”œâ”€â”€ dev (latest dev version)
        Note right of R2_BUCKET: â”‚   â””â”€â”€ lastUpdated (timestamp)
        Note right of R2_BUCKET: â””â”€â”€ template-metadata.json:
        Note right of R2_BUCKET:     â”œâ”€â”€ name, description
        Note right of R2_BUCKET:     â”œâ”€â”€ version, dependencies
        Note right of R2_BUCKET:     â”œâ”€â”€ category, tags
        Note right of R2_BUCKET:     â””â”€â”€ compatibility info
    end

    %% === STORAGE CLIENT ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð ===
    rect rgb(240, 248, 255)
        Note over STORAGE_CLIENT: ðŸ’¾ STORAGE CLIENT ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð
        
        Note left of STORAGE_CLIENT: CLIENT ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯
        Note left of STORAGE_CLIENT: â”œâ”€â”€ packages/storage/
        Note left of STORAGE_CLIENT: â”‚   â”œâ”€â”€ src/
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”œâ”€â”€ client.ts (R2 client)
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”œâ”€â”€ types.ts (TypeScript types)
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”œâ”€â”€ managers/
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”‚   â”œâ”€â”€ ToolbarManager.ts
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”‚   â”œâ”€â”€ TemplateManager.ts
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”‚   â””â”€â”€ BackupManager.ts
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”œâ”€â”€ utils/
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”‚   â”œâ”€â”€ upload.ts
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”‚   â”œâ”€â”€ download.ts
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”‚   â”œâ”€â”€ checksum.ts
        Note left of STORAGE_CLIENT: â”‚   â”‚   â”‚   â””â”€â”€ compression.ts
        Note left of STORAGE_CLIENT: â”‚   â”‚   â””â”€â”€ errors/
        Note left of STORAGE_CLIENT: â”‚   â”‚       â””â”€â”€ StorageError.ts
        Note left of STORAGE_CLIENT: â”‚   â””â”€â”€ package.json

        Note right of STORAGE_CLIENT: AWS S3 COMPATIBLE API
        Note right of STORAGE_CLIENT: â”œâ”€â”€ @aws-sdk/client-s3
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Endpoint: R2_ENDPOINT
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Credentials: ACCESS_KEY + SECRET
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Region: auto (Cloudflare manages)
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Signature V4 authentication
        Note right of STORAGE_CLIENT: â””â”€â”€ HTTPS only connections

        Note over STORAGE_CLIENT: ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜
        Note over STORAGE_CLIENT: â”œâ”€â”€ putObject() - Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²
        Note over STORAGE_CLIENT: â”œâ”€â”€ getObject() - ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²
        Note over STORAGE_CLIENT: â”œâ”€â”€ deleteObject() - ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²
        Note over STORAGE_CLIENT: â”œâ”€â”€ listObjects() - Ð»Ð¸ÑÑ‚Ð¸Ð½Ð³ Ñ„Ð°Ð¹Ð»Ð¾Ð²
        Note over STORAGE_CLIENT: â”œâ”€â”€ headObject() - Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ð°
        Note over STORAGE_CLIENT: â””â”€â”€ copyObject() - ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²

        alt Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            WEB->>STORAGE_CLIENT: createR2Client(config)
            STORAGE_CLIENT->>STORAGE_CLIENT: S3Client Ñ R2 endpoint
            STORAGE_CLIENT->>R2_API: Test connection
            R2_API-->>STORAGE_CLIENT: Connection verified
            STORAGE_CLIENT-->>WEB: Ready client instance
        end
        
        alt Upload Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
            WEB->>STORAGE_CLIENT: uploadFile(key, buffer, metadata)
            STORAGE_CLIENT->>STORAGE_CLIENT: Validate file Ñ€Ð°Ð·Ð¼ÐµÑ€/Ñ‚Ð¸Ð¿
            STORAGE_CLIENT->>STORAGE_CLIENT: Generate checksum
            STORAGE_CLIENT->>R2_API: putObject Ñ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
            R2_API-->>STORAGE_CLIENT: Upload success + ETag
            STORAGE_CLIENT-->>WEB: File uploaded successfully
        end
    end

    %% === TOOLBAR VERSION MANAGEMENT ===
    rect rgb(255, 250, 240)
        Note over TOOLBAR: ðŸ› ï¸ TOOLBAR VERSION MANAGEMENT
        
        Note left of TOOLBAR: TOOLBAR MANAGER ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜
        Note left of TOOLBAR: â”œâ”€â”€ uploadVersion(version, channel, zipBuffer)
        Note left of TOOLBAR: â”œâ”€â”€ getLatestVersion(channel)
        Note left of TOOLBAR: â”œâ”€â”€ downloadVersion(version, channel)
        Note left of TOOLBAR: â”œâ”€â”€ updateChannels(channelMap)
        Note left of TOOLBAR: â”œâ”€â”€ deleteVersion(version)
        Note left of TOOLBAR: â””â”€â”€ getVersionHistory()

        Note right of TOOLBAR: VERSION LIFECYCLE
        Note right of TOOLBAR: â”œâ”€â”€ Upload â†’ Validation â†’ Storage
        Note right of TOOLBAR: â”œâ”€â”€ Checksum generation â†’ Metadata creation
        Note right of TOOLBAR: â”œâ”€â”€ Channel assignment â†’ Index update
        Note right of TOOLBAR: â”œâ”€â”€ Download tracking â†’ Usage metrics
        Note right of TOOLBAR: â””â”€â”€ Cleanup â†’ Old version removal

        alt Upload Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ toolbar
            ADMIN->>STORAGE_CLIENT: ToolbarManager.uploadVersion()
            STORAGE_CLIENT->>STORAGE_CLIENT: Validate ZIP structure
            STORAGE_CLIENT->>STORAGE_CLIENT: Generate SHA-256 checksum
            STORAGE_CLIENT->>R2_API: Upload ZIP to /toolbar-versions/{version}/{channel}/
            R2_API->>R2_BUCKET: Store toolbar.zip
            STORAGE_CLIENT->>R2_API: Upload metadata.json
            R2_API->>R2_BUCKET: Store metadata
            STORAGE_CLIENT->>STORAGE_CLIENT: Update channels.json
            STORAGE_CLIENT->>R2_API: Update /latest/channels.json
            STORAGE_CLIENT-->>ADMIN: Version uploaded successfully
        end
        
        alt ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹
            TOOLBAR->>STORAGE_CLIENT: ToolbarManager.getLatestVersion(channel)
            STORAGE_CLIENT->>R2_API: GET /latest/channels.json
            R2_API->>R2_BUCKET: Retrieve channels info
            R2_BUCKET-->>R2_API: Current channel versions
            R2_API-->>STORAGE_CLIENT: Channel version data
            STORAGE_CLIENT->>STORAGE_CLIENT: Compare Ñ current version
            STORAGE_CLIENT-->>TOOLBAR: {hasUpdate, version, downloadUrl}
        end
        
        alt Download toolbar Ð²ÐµÑ€ÑÐ¸Ð¸
            TOOLBAR->>STORAGE_CLIENT: ToolbarManager.downloadVersion()
            STORAGE_CLIENT->>R2_API: GET /toolbar-versions/{version}/{channel}/toolbar.zip
            R2_API->>R2_BUCKET: Retrieve ZIP file
            R2_BUCKET-->>R2_API: ZIP buffer
            R2_API-->>STORAGE_CLIENT: File data
            STORAGE_CLIENT->>STORAGE_CLIENT: Verify checksum
            STORAGE_CLIENT-->>TOOLBAR: Validated ZIP buffer
        end
    end

    %% === TEMPLATE MANAGEMENT ===
    rect rgb(250, 255, 245)
        Note over STORAGE_CLIENT: ðŸ“„ TEMPLATE MANAGEMENT
        
        Note left of STORAGE_CLIENT: TEMPLATE MANAGER ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜  
        Note left of STORAGE_CLIENT: â”œâ”€â”€ uploadTemplate(name, zipBuffer, metadata)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ getTemplate(name)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ downloadTemplate(name)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ updateTemplateMetadata(name, metadata)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ deleteTemplate(name)
        Note left of STORAGE_CLIENT: â””â”€â”€ listAvailableTemplates()

        Note right of STORAGE_CLIENT: TEMPLATE Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Template ZIP contents:
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ src/ (source files)
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ public/ (static assets)
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ package.json (dependencies)
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ vite.config.ts (build config)
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ vybcel.config.json (project config)
        Note right of STORAGE_CLIENT: â”‚   â””â”€â”€ README.md (documentation)
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Metadata fields:
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ name, description, version
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ category, tags, difficulty
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ dependencies, compatibility
        Note right of STORAGE_CLIENT: â”‚   â””â”€â”€ preview images, demo URL

        alt Upload Ð½Ð¾Ð²Ð¾Ð³Ð¾ template
            WEB->>STORAGE_CLIENT: TemplateManager.uploadTemplate()
            STORAGE_CLIENT->>STORAGE_CLIENT: Validate template structure
            STORAGE_CLIENT->>STORAGE_CLIENT: Extract package.json dependencies
            STORAGE_CLIENT->>R2_API: Upload template.zip
            R2_API->>R2_BUCKET: Store Ð² /project-templates/{name}/
            STORAGE_CLIENT->>R2_API: Upload template-metadata.json
            STORAGE_CLIENT-->>WEB: Template uploaded
        end
        
        alt Download template Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            WEB->>STORAGE_CLIENT: TemplateManager.downloadTemplate('vite-react')
            STORAGE_CLIENT->>R2_API: GET /project-templates/vite-react/template.zip
            R2_API->>R2_BUCKET: Retrieve template
            R2_BUCKET-->>R2_API: Template ZIP buffer
            R2_API-->>STORAGE_CLIENT: File data
            STORAGE_CLIENT->>STORAGE_CLIENT: Template customization (PROJECT_ID injection)
            STORAGE_CLIENT-->>WEB: Customized project ZIP
        end
    end

    %% === BACKUP MANAGEMENT ===
    rect rgb(255, 245, 250)
        Note over STORAGE_CLIENT: ðŸ’¾ BACKUP MANAGEMENT
        
        Note left of STORAGE_CLIENT: BACKUP MANAGER ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜
        Note left of STORAGE_CLIENT: â”œâ”€â”€ createSnapshot(projectId, files)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ createIncremental(projectId, changes)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ restoreSnapshot(projectId, snapshotId)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ listSnapshots(projectId)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ deleteSnapshot(projectId, snapshotId)
        Note left of STORAGE_CLIENT: â””â”€â”€ cleanupOldBackups(projectId, retentionDays)

        Note right of STORAGE_CLIENT: BACKUP Ð¢Ð˜ÐŸÐ«
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Full Snapshots:
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ ÐŸÐ¾Ð»Ð½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð¾Ð´Ð½Ð¾Ð¼ ZIP
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ major changes
        Note right of STORAGE_CLIENT: â”‚   â””â”€â”€ Retention: 30 Ð´Ð½ÐµÐ¹
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Incremental Backups:
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ Delta Ð¾Ñ‚ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ snapshot
        Note right of STORAGE_CLIENT: â”‚   â”œâ”€â”€ Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
        Note right of STORAGE_CLIENT: â”‚   â””â”€â”€ Retention: 7 Ð´Ð½ÐµÐ¹
        Note right of STORAGE_CLIENT: â””â”€â”€ Emergency Backups:
        Note right of STORAGE_CLIENT:     â”œâ”€â”€ ÐŸÐµÑ€ÐµÐ´ destructive operations
        Note right of STORAGE_CLIENT:     â”œâ”€â”€ Critical state preservation
        Note right of STORAGE_CLIENT:     â””â”€â”€ Manual cleanup required

        alt Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ snapshot backup
            WEB->>STORAGE_CLIENT: BackupManager.createSnapshot(projectId)
            STORAGE_CLIENT->>STORAGE_CLIENT: Collect all project files
            STORAGE_CLIENT->>STORAGE_CLIENT: Create ZIP archive
            STORAGE_CLIENT->>STORAGE_CLIENT: Generate snapshot metadata
            STORAGE_CLIENT->>R2_API: Upload snapshot
            R2_API->>R2_BUCKET: Store Ð² /project-backups/{projectId}/snapshots/
            STORAGE_CLIENT-->>WEB: Snapshot created successfully
        end
        
        alt Cleanup ÑÑ‚Ð°Ñ€Ñ‹Ñ… backups
            STORAGE_CLIENT->>STORAGE_CLIENT: BackupManager.cleanupOldBackups()
            STORAGE_CLIENT->>R2_API: List old snapshots
            R2_API-->>STORAGE_CLIENT: Snapshots older than retention
            STORAGE_CLIENT->>R2_API: Batch delete old snapshots
            R2_API->>R2_BUCKET: Remove expired backups
            STORAGE_CLIENT->>STORAGE_CLIENT: Update backup index
        end
    end

    %% === CDN Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯ ===
    rect rgb(245, 255, 245)
        Note over CDN: ðŸŒ CLOUDFLARE CDN Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯
        
        Note left of CDN: CDN ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯
        Note left of CDN: â”œâ”€â”€ Global edge locations (300+)
        Note left of CDN: â”œâ”€â”€ Automatic caching headers
        Note left of CDN: â”œâ”€â”€ Brotli/Gzip compression
        Note left of CDN: â”œâ”€â”€ HTTP/2 Ð¸ HTTP/3 support
        Note left of CDN: â”œâ”€â”€ Custom cache rules
        Note left of CDN: â”œâ”€â”€ Purge API Ð´Ð»Ñ cache invalidation
        Note left of CDN: â””â”€â”€ Analytics Ð¸ metrics

        Note right of CDN: CACHING Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯
        Note right of CDN: â”œâ”€â”€ Static assets (toolbar, templates):
        Note right of CDN: â”‚   â”œâ”€â”€ Cache TTL: 1 hour
        Note right of CDN: â”‚   â”œâ”€â”€ Browser cache: 24 hours
        Note right of CDN: â”‚   â””â”€â”€ Auto-purge Ð¿Ñ€Ð¸ updates
        Note right of CDN: â”œâ”€â”€ Metadata files:
        Note right of CDN: â”‚   â”œâ”€â”€ Cache TTL: 5 minutes
        Note right of CDN: â”‚   â”œâ”€â”€ Revalidation strategy
        Note right of CDN: â”‚   â””â”€â”€ ETag-based freshness
        Note right of CDN: â””â”€â”€ Download URLs:
        Note right of CDN:     â”œâ”€â”€ Signed URLs Ñ expiration
        Note right of CDN:     â”œâ”€â”€ Geographic optimization
        Note right of CDN:     â””â”€â”€ Bandwidth throttling

        alt CDN cache invalidation
            STORAGE_CLIENT->>CDN: New version uploaded
            CDN->>CDN: Detect file change (ETag)
            CDN->>CDN: Purge cache Ð´Ð»Ñ affected paths
            CDN->>CDN: Warm cache Ð½Ð° popular edges
            CDN-->>STORAGE_CLIENT: Cache updated globally
        end
        
        alt Optimized download
            TOOLBAR->>CDN: Request toolbar update
            CDN->>CDN: Route to nearest edge
            CDN->>CDN: Serve Ð¾Ñ‚ cache ÐµÑÐ»Ð¸ available
            alt Cache miss
                CDN->>R2_BUCKET: Fetch Ð¾Ñ‚ origin
                R2_BUCKET-->>CDN: File data
                CDN->>CDN: Cache Ð´Ð»Ñ future requests
            end
            CDN-->>TOOLBAR: Optimized delivery
        end
    end

    %% === ÐÐ”ÐœÐ˜ÐÐ˜Ð¡Ð¢Ð Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• ===
    rect rgb(255, 255, 245)
        Note over ADMIN: ðŸ‘¨â€ðŸ’¼ ÐÐ”ÐœÐ˜ÐÐ˜Ð¡Ð¢Ð Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð˜ ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“
        
        Note left of ADMIN: ADMIN ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜
        Note left of ADMIN: â”œâ”€â”€ Storage usage monitoring
        Note left of ADMIN: â”œâ”€â”€ Upload/download metrics
        Note left of ADMIN: â”œâ”€â”€ Cost optimization
        Note left of ADMIN: â”œâ”€â”€ Bandwidth tracking
        Note left of ADMIN: â”œâ”€â”€ Error rate monitoring
        Note left of ADMIN: â”œâ”€â”€ Performance analytics
        Note left of ADMIN: â””â”€â”€ Automated cleanup jobs

        Note right of ADMIN: ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“ ÐœÐ•Ð¢Ð Ð˜ÐšÐ˜
        Note right of ADMIN: â”œâ”€â”€ Storage utilization (GB)
        Note right of ADMIN: â”œâ”€â”€ Request count (operations/day)
        Note right of ADMIN: â”œâ”€â”€ Bandwidth usage (GB/month)
        Note right of ADMIN: â”œâ”€â”€ Error rates (4xx/5xx)
        Note right of ADMIN: â”œâ”€â”€ Cache hit ratio (%)
        Note right of ADMIN: â”œâ”€â”€ Geographic distribution
        Note right of ADMIN: â””â”€â”€ Cost per operation

        alt Daily maintenance
            ADMIN->>STORAGE_CLIENT: Scheduled cleanup job
            STORAGE_CLIENT->>STORAGE_CLIENT: Analyze storage usage
            STORAGE_CLIENT->>STORAGE_CLIENT: Identify orphaned files
            STORAGE_CLIENT->>R2_API: Batch delete unused files
            STORAGE_CLIENT->>STORAGE_CLIENT: Update storage statistics
            STORAGE_CLIENT-->>ADMIN: Cleanup report
        end
    end

    %% === Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ¡Ð¢Ð¬ Ð˜ Ð”ÐžÐ¡Ð¢Ð£ÐŸ ===
    rect rgb(255, 245, 245)
        Note over R2_API: ðŸ”’ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ¡Ð¢Ð¬ Ð˜ ÐšÐžÐÐ¢Ð ÐžÐ›Ð¬ Ð”ÐžÐ¡Ð¢Ð£ÐŸÐ
        
        Note left of R2_API: ACCESS CONTROL
        Note left of R2_API: â”œâ”€â”€ IAM policies (Cloudflare)
        Note left of R2_API: â”œâ”€â”€ API token scoping
        Note left of R2_API: â”œâ”€â”€ Bucket-level permissions
        Note left of R2_API: â”œâ”€â”€ Object-level access control
        Note left of R2_API: â”œâ”€â”€ CORS configuration
        Note left of R2_API: â”œâ”€â”€ Referrer restrictions
        Note left of R2_API: â””â”€â”€ Rate limiting

        Note right of R2_API: DATA PROTECTION
        Note right of R2_API: â”œâ”€â”€ Encryption at rest (AES-256)
        Note right of R2_API: â”œâ”€â”€ Encryption in transit (TLS 1.3)
        Note right of R2_API: â”œâ”€â”€ Signed URLs Ð´Ð»Ñ controlled access
        Note right of R2_API: â”œâ”€â”€ Checksum validation
        Note right of R2_API: â”œâ”€â”€ Version immutability
        Note right of R2_API: â”œâ”€â”€ Audit logging
        Note right of R2_API: â””â”€â”€ Geographic data residency

        alt Secure file upload
            ADMIN->>STORAGE_CLIENT: Upload sensitive file
            STORAGE_CLIENT->>STORAGE_CLIENT: Generate checksum
            STORAGE_CLIENT->>STORAGE_CLIENT: Encrypt metadata
            STORAGE_CLIENT->>R2_API: Secure upload with signature
            R2_API->>R2_BUCKET: Store with encryption
            R2_API-->>STORAGE_CLIENT: Upload verified
        end
        
        alt Access audit
            R2_API->>R2_API: Log all access operations
            R2_API->>R2_API: Monitor unusual patterns
            R2_API->>ADMIN: Security alerts ÐµÑÐ»Ð¸ needed
        end
    end

    %% === PERFORMANCE OPTIMIZATION ===
    rect rgb(250, 250, 255)
        Note over STORAGE_CLIENT: âš¡ PERFORMANCE OPTIMIZATION
        
        Note left of STORAGE_CLIENT: UPLOAD OPTIMIZATION
        Note left of STORAGE_CLIENT: â”œâ”€â”€ Multipart uploads Ð´Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        Note left of STORAGE_CLIENT: â”œâ”€â”€ Parallel uploads (chunking)
        Note left of STORAGE_CLIENT: â”œâ”€â”€ Compression before upload
        Note left of STORAGE_CLIENT: â”œâ”€â”€ Deduplication checks
        Note left of STORAGE_CLIENT: â”œâ”€â”€ Retry mechanisms
        Note left of STORAGE_CLIENT: â””â”€â”€ Progress tracking

        Note right of STORAGE_CLIENT: DOWNLOAD OPTIMIZATION  
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Range requests support
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Streaming downloads
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Client-side caching
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Parallel chunk downloads
        Note right of STORAGE_CLIENT: â”œâ”€â”€ Resume capability
        Note right of STORAGE_CLIENT: â””â”€â”€ Bandwidth adaptive delivery

        alt Optimized large file upload
            WEB->>STORAGE_CLIENT: Upload large ZIP (>100MB)
            STORAGE_CLIENT->>STORAGE_CLIENT: Split Ð² chunks (10MB each)
            
            loop Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ chunk
                STORAGE_CLIENT->>R2_API: Upload chunk part
                R2_API-->>STORAGE_CLIENT: Part ETag
            end
            
            STORAGE_CLIENT->>R2_API: Complete multipart upload
            R2_API->>R2_BUCKET: Assemble final object
            R2_API-->>STORAGE_CLIENT: Upload completed
        end
    end
</rewritten_file>