sequenceDiagram
    participant WEB as ðŸŒ Web App
    participant WS as ðŸ”„ WebSocket Server
    participant IO as ðŸ“¡ Socket.IO
    participant GITHUB as ðŸ› ï¸ GitHub Service
    participant NETLIFY as ðŸš€ Netlify Service
    participant PROJECT as ðŸ“ Project Service
    participant DB as ðŸ—ƒï¸ Database
    participant AGENT as ðŸ“± Dev Agent

    Note over WEB,AGENT: ðŸ”„ WEBSOCKET SERVER - Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐÐ¯ ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð

    %% === Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð Ð¡Ð•Ð Ð’Ð•Ð Ð ===
    rect rgb(245, 255, 245)
        Note over WS: ðŸ“ Ð¤ÐÐ™Ð›ÐžÐ’ÐÐ¯ Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð Ð¡Ð•Ð Ð’Ð•Ð Ð
        
        Note left of WS: apps/websocket-server/
        Note left of WS: â”œâ”€â”€ src/
        Note left of WS: â”‚   â”œâ”€â”€ index.ts (Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»)
        Note left of WS: â”‚   â”œâ”€â”€ server.ts (Express app)
        Note left of WS: â”‚   â”œâ”€â”€ socket.ts (Socket.IO setup)
        Note left of WS: â”‚   â”œâ”€â”€ services/
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ github.ts
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ netlify.ts
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ project.ts
        Note left of WS: â”‚   â”‚   â””â”€â”€ r2-storage.ts
        Note left of WS: â”‚   â”œâ”€â”€ handlers/
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ auth.ts
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ files.ts
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ commits.ts
        Note left of WS: â”‚   â”‚   â””â”€â”€ toolbar.ts
        Note left of WS: â”‚   â”œâ”€â”€ utils/
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ git.ts
        Note left of WS: â”‚   â”‚   â”œâ”€â”€ validation.ts
        Note left of WS: â”‚   â”‚   â””â”€â”€ logger.ts
        Note left of WS: â”‚   â””â”€â”€ types/
        Note left of WS: â”‚       â”œâ”€â”€ socket.ts
        Note left of WS: â”‚       â”œâ”€â”€ github.ts
        Note left of WS: â”‚       â””â”€â”€ project.ts
        Note left of WS: â”œâ”€â”€ package.json
        Note left of WS: â”œâ”€â”€ tsconfig.json
        Note left of WS: â””â”€â”€ .env

        Note right of WS: ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢Ð«
        Note right of WS: â”œâ”€â”€ Express.js HTTP ÑÐµÑ€Ð²ÐµÑ€ (Ð¿Ð¾Ñ€Ñ‚ 8080)
        Note right of WS: â”œâ”€â”€ Socket.IO WebSocket ÑÐµÑ€Ð²ÐµÑ€
        Note right of WS: â”œâ”€â”€ GitHub App Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ
        Note right of WS: â”œâ”€â”€ Netlify API ÐºÐ»Ð¸ÐµÐ½Ñ‚
        Note right of WS: â”œâ”€â”€ Supabase Database ÐºÐ»Ð¸ÐµÐ½Ñ‚
        Note right of WS: â”œâ”€â”€ Cloudflare R2 ÐºÐ»Ð¸ÐµÐ½Ñ‚
        Note right of WS: â””â”€â”€ Memory store Ð´Ð»Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
    end

    %% === SOCKET.IO ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð ===
    rect rgb(240, 248, 255)
        Note over IO: ðŸ“¡ SOCKET.IO ÐÐ Ð¥Ð˜Ð¢Ð•ÐšÐ¢Ð£Ð Ð
        
        Note left of IO: WEBSOCKET Ð¡ÐžÐ‘Ð«Ð¢Ð˜Ð¯
        Note left of IO: Ð’Ð¥ÐžÐ”Ð¯Ð©Ð˜Ð• Ð¡ÐžÐ‘Ð«Ð¢Ð˜Ð¯:
        Note left of IO: â”œâ”€â”€ authenticate
        Note left of IO: â”‚   â””â”€â”€ {projectId, clientType}
        Note left of IO: â”œâ”€â”€ file_change
        Note left of IO: â”‚   â””â”€â”€ {filePath, content, action}
        Note left of IO: â”œâ”€â”€ save_all_changes
        Note left of IO: â”‚   â””â”€â”€ {projectId}
        Note left of IO: â”œâ”€â”€ discard_all_changes
        Note left of IO: â”‚   â””â”€â”€ {projectId}
        Note left of IO: â”œâ”€â”€ toolbar_connected
        Note left of IO: â”‚   â””â”€â”€ {projectId, version}
        Note left of IO: â””â”€â”€ ping
        Note left of IO:     â””â”€â”€ keepalive

        Note right of IO: Ð˜Ð¡Ð¥ÐžÐ”Ð¯Ð©Ð˜Ð• Ð¡ÐžÐ‘Ð«Ð¢Ð˜Ð¯:
        Note right of IO: â”œâ”€â”€ authenticated
        Note right of IO: â”‚   â””â”€â”€ {success, projectData}
        Note right of IO: â”œâ”€â”€ file_change_staged
        Note right of IO: â”‚   â””â”€â”€ {pendingChanges}
        Note right of IO: â”œâ”€â”€ commit_created
        Note right of IO: â”‚   â””â”€â”€ {commitData, history}
        Note right of IO: â”œâ”€â”€ deploy_status_update
        Note right of IO: â”‚   â””â”€â”€ {status, url, logs}
        Note right of IO: â”œâ”€â”€ toolbar_update_available
        Note right of IO: â”‚   â””â”€â”€ {version, hasUpdate}
        Note right of IO: â”œâ”€â”€ agent_connected
        Note right of IO: â”‚   â””â”€â”€ {projectId, agentStatus}
        Note right of IO: â””â”€â”€ error
        Note right of IO:     â””â”€â”€ {message, code}

        alt ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            AGENT->>IO: WebSocket connection
            IO->>IO: socket.on('connection')
            IO->>IO: ÐŸÑ€Ð¸ÑÐ²Ð¾ÐµÐ½Ð¸Ðµ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ socket.id
            IO-->>AGENT: Connection established
        end
        
        alt ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ
            AGENT->>IO: emit('authenticate', {projectId})
            IO->>DB: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            IO->>IO: socket.join(`project_${projectId}`)
            IO-->>AGENT: emit('authenticated', {success: true})
        end
    end

    %% === ÐšÐžÐœÐÐÐ¢Ð« Ð˜ Ð¡ÐžÐ•Ð”Ð˜ÐÐ•ÐÐ˜Ð¯ ===
    rect rgb(255, 250, 240)
        Note over IO: ðŸ  ÐšÐžÐœÐÐÐ¢Ð« Ð˜ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• Ð¡ÐžÐ•Ð”Ð˜ÐÐ•ÐÐ˜Ð¯ÐœÐ˜
        
        Note left of IO: Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐšÐžÐœÐÐÐ¢
        Note left of IO: â”œâ”€â”€ project_{projectId}
        Note left of IO: â”‚   â”œâ”€â”€ Web ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ (Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ñ‹)
        Note left of IO: â”‚   â”œâ”€â”€ Dev Agent (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹)
        Note left of IO: â”‚   â””â”€â”€ Toolbar ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹
        Note left of IO: â”œâ”€â”€ admin_toolbar
        Note left of IO: â”‚   â””â”€â”€ ÐÐ´Ð¼Ð¸Ð½ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ
        Note left of IO: â””â”€â”€ global
        Note left of IO:     â””â”€â”€ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ

        Note right of IO: Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð• Ð¡ÐžÐ•Ð”Ð˜ÐÐ•ÐÐ˜Ð™
        Note right of IO: â”œâ”€â”€ connectedAgents Map
        Note right of IO: â”‚   â””â”€â”€ {socketId: projectId}
        Note right of IO: â”œâ”€â”€ connectedClients Map
        Note right of IO: â”‚   â””â”€â”€ {socketId: {projectId, type}}
        Note right of IO: â”œâ”€â”€ activeProjects Set
        Note right of IO: â”‚   â””â”€â”€ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²
        Note right of IO: â””â”€â”€ connectionStats Object
        Note right of IO:     â””â”€â”€ Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹

        alt Broadcast Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            WS->>IO: io.to(`project_${projectId}`)
            IO->>IO: ÐŸÐ¾Ð¸ÑÐº Ð²ÑÐµÑ… ÑÐ¾ÐºÐµÑ‚Ð¾Ð² Ð² ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ
            IO->>AGENT: emit('file_change_staged')
            IO->>WEB: emit('file_change_staged')
        end
        
        alt ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            AGENT->>IO: disconnect event
            IO->>IO: socket.on('disconnect')
            IO->>IO: Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· Maps Ð¸ Sets
            IO->>WEB: emit('agent_disconnected')
        end
    end

    %% === GITHUB SERVICE ===
    rect rgb(250, 245, 255)
        Note over GITHUB: ðŸ™ GITHUB SERVICE Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯
        
        Note left of GITHUB: GITHUB APP ÐÐ£Ð¢Ð•ÐÐ¢Ð˜Ð¤Ð˜ÐšÐÐ¦Ð˜Ð¯
        Note left of GITHUB: â”œâ”€â”€ App ID: 1390062
        Note left of GITHUB: â”œâ”€â”€ Installation ID: 70719351
        Note left of GITHUB: â”œâ”€â”€ Private Key (JWT Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ)
        Note left of GITHUB: â”œâ”€â”€ Installation Token (60 Ð¼Ð¸Ð½)
        Note left of GITHUB: â””â”€â”€ Organization: vybcel

        Note right of GITHUB: API ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜
        Note right of GITHUB: â”œâ”€â”€ createRepository()
        Note right of GITHUB: â”‚   â””â”€â”€ POST /orgs/vybcel/repos
        Note right of GITHUB: â”œâ”€â”€ uploadFiles()
        Note right of GITHUB: â”‚   â””â”€â”€ PUT /repos/{owner}/{repo}/contents/{path}
        Note right of GITHUB: â”œâ”€â”€ createCommit()
        Note right of GITHUB: â”‚   â””â”€â”€ POST /repos/{owner}/{repo}/git/commits
        Note right of GITHUB: â”œâ”€â”€ updateRef()
        Note right of GITHUB: â”‚   â””â”€â”€ PATCH /repos/{owner}/{repo}/git/refs/heads/main
        Note right of GITHUB: â””â”€â”€ deleteRepository()
        Note right of GITHUB:     â””â”€â”€ DELETE /repos/{owner}/{repo}

        alt Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
            WS->>GITHUB: createRepository(projectId)
            GITHUB->>GITHUB: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ installation token
            GITHUB->>GITHUB: POST /orgs/vybcel/repos
            GITHUB->>DB: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ repo Ð´Ð°Ð½Ð½Ñ‹Ñ…
            GITHUB-->>WS: {repoUrl, repoName}
        end
        
        alt Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
            WS->>GITHUB: createCommit(files, message)
            GITHUB->>GITHUB: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ blobs Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²
            GITHUB->>GITHUB: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ tree Ñ blobs
            GITHUB->>GITHUB: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ commit Ñ tree
            GITHUB->>GITHUB: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ main ref
            GITHUB-->>WS: {commitSha, commitUrl}
        end
    end

    %% === NETLIFY SERVICE ===
    rect rgb(255, 245, 250)
        Note over NETLIFY: ðŸš€ NETLIFY SERVICE Ð˜ÐÐ¢Ð•Ð“Ð ÐÐ¦Ð˜Ð¯
        
        Note left of NETLIFY: NETLIFY API ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜
        Note left of NETLIFY: â”œâ”€â”€ createSite()
        Note left of NETLIFY: â”‚   â””â”€â”€ POST /sites
        Note left of NETLIFY: â”œâ”€â”€ updateSite()
        Note left of NETLIFY: â”‚   â””â”€â”€ PATCH /sites/{site_id}
        Note left of NETLIFY: â”œâ”€â”€ deleteSite()
        Note left of NETLIFY: â”‚   â””â”€â”€ DELETE /sites/{site_id}
        Note left of NETLIFY: â”œâ”€â”€ setupWebhook()
        Note left of NETLIFY: â”‚   â””â”€â”€ POST /hooks
        Note left of NETLIFY: â””â”€â”€ getBuildStatus()
        Note left of NETLIFY:     â””â”€â”€ GET /sites/{site_id}/deploys

        Note right of NETLIFY: WEBHOOK ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ
        Note right of NETLIFY: â”œâ”€â”€ deploy-building
        Note right of NETLIFY: â”œâ”€â”€ deploy-succeeded  
        Note right of NETLIFY: â”œâ”€â”€ deploy-failed
        Note right of NETLIFY: â””â”€â”€ deploy-cancelled

        alt Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Netlify ÑÐ°Ð¹Ñ‚Ð°
            WS->>NETLIFY: createSite(repoUrl, buildSettings)
            NETLIFY->>NETLIFY: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ°Ð¹Ñ‚Ð° Ñ GitHub Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÐµÐ¹
            NETLIFY->>NETLIFY: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° build commands
            NETLIFY->>NETLIFY: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° deploy key
            NETLIFY-->>WS: {siteId, siteUrl, deployUrl}
        end
        
        alt Webhook Ð¾Ñ‚ Netlify
            NETLIFY->>WS: POST /webhooks/netlify
            WS->>WS: ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ webhook payload
            WS->>DB: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ deploy_status
            WS->>IO: Broadcast deploy_status_update
        end
    end

    %% === PROJECT SERVICE ===
    rect rgb(240, 255, 240)
        Note over PROJECT: ðŸ“ PROJECT SERVICE
        
        Note left of PROJECT: ÐžÐŸÐ•Ð ÐÐ¦Ð˜Ð˜ Ð¡ ÐŸÐ ÐžÐ•ÐšÐ¢ÐÐœÐ˜
        Note left of PROJECT: â”œâ”€â”€ initializeProject()
        Note left of PROJECT: â”‚   â”œâ”€â”€ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ GitHub Ñ€ÐµÐ¿Ð¾
        Note left of PROJECT: â”‚   â”œâ”€â”€ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°
        Note left of PROJECT: â”‚   â””â”€â”€ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²
        Note left of PROJECT: â”œâ”€â”€ commitAllChanges()
        Note left of PROJECT: â”‚   â”œâ”€â”€ Ð¡Ð±Ð¾Ñ€ pending changes
        Note left of PROJECT: â”‚   â”œâ”€â”€ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
        Note left of PROJECT: â”‚   â””â”€â”€ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° staging
        Note left of PROJECT: â”œâ”€â”€ discardAllChanges()
        Note left of PROJECT: â”‚   â”œâ”€â”€ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° pending changes
        Note left of PROJECT: â”‚   â””â”€â”€ Git reset Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
        Note left of PROJECT: â””â”€â”€ deleteProject()
        Note left of PROJECT:     â”œâ”€â”€ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ GitHub Ñ€ÐµÐ¿Ð¾
        Note left of PROJECT:     â”œâ”€â”€ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Netlify ÑÐ°Ð¹Ñ‚Ð°
        Note left of PROJECT:     â””â”€â”€ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð‘Ð”

        Note right of PROJECT: Ð¤ÐžÐÐžÐ’Ð«Ð• Ð—ÐÐ”ÐÐ§Ð˜
        Note right of PROJECT: â”œâ”€â”€ initializeProjectInBackground()
        Note right of PROJECT: â”‚   â””â”€â”€ Async Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°
        Note right of PROJECT: â”œâ”€â”€ syncWithGitHub()
        Note right of PROJECT: â”‚   â””â”€â”€ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
        Note right of PROJECT: â”œâ”€â”€ cleanupOldProjects()
        Note right of PROJECT: â”‚   â””â”€â”€ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²
        Note right of PROJECT: â””â”€â”€ healthCheck()
        Note right of PROJECT:     â””â”€â”€ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²

        alt Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            WS->>PROJECT: initializeProject(projectId)
            PROJECT->>GITHUB: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
            PROJECT->>PROJECT: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°
            PROJECT->>GITHUB: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² Ñ€ÐµÐ¿Ð¾
            PROJECT->>DB: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            PROJECT-->>WS: ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð³Ð¾Ñ‚Ð¾Ð²
        end
        
        alt Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
            WS->>PROJECT: commitAllChanges(projectId)
            PROJECT->>DB: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ pending changes
            PROJECT->>GITHUB: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
            PROJECT->>DB: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° pending changes
            PROJECT->>NETLIFY: Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð°Ð²Ñ‚Ð¾Ð´ÐµÐ¿Ð»Ð¾Ñ
            PROJECT-->>WS: ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½
        end
    end

    %% === HTTP API ENDPOINTS ===
    rect rgb(250, 250, 245)
        Note over WS: ðŸŒ HTTP API ENDPOINTS
        
        Note left of WS: REST API ÐœÐÐ Ð¨Ð Ð£Ð¢Ð«
        Note left of WS: â”œâ”€â”€ POST /api/projects/create-repository
        Note left of WS: â”‚   â””â”€â”€ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ GitHub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        Note left of WS: â”œâ”€â”€ POST /api/projects/initialize
        Note left of WS: â”‚   â””â”€â”€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        Note left of WS: â”œâ”€â”€ POST /api/projects/:id/commit
        Note left of WS: â”‚   â””â”€â”€ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
        Note left of WS: â”œâ”€â”€ POST /api/projects/:id/discard
        Note left of WS: â”‚   â””â”€â”€ ÐžÑ‚Ð¼ÐµÐ½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
        Note left of WS: â”œâ”€â”€ POST /api/webhooks/netlify
        Note left of WS: â”‚   â””â”€â”€ Webhook Ð¾Ñ‚ Netlify
        Note left of WS: â”œâ”€â”€ POST /api/webhooks/github
        Note left of WS: â”‚   â””â”€â”€ Webhook Ð¾Ñ‚ GitHub
        Note left of WS: â”œâ”€â”€ GET /api/health
        Note left of WS: â”‚   â””â”€â”€ Health check
        Note left of WS: â””â”€â”€ POST /api/notify-status-change
        Note left of WS:     â””â”€â”€ ÐœÐµÐ¶ÑÐµÑ€Ð²Ð¸ÑÐ½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ

        Note right of WS: MIDDLEWARE
        Note right of WS: â”œâ”€â”€ cors() - CORS policy
        Note right of WS: â”œâ”€â”€ express.json() - Body parser
        Note right of WS: â”œâ”€â”€ rateLimit() - Rate limiting
        Note right of WS: â”œâ”€â”€ validateApiKey() - API auth
        Note right of WS: â””â”€â”€ errorHandler() - Error handling

        alt HTTP Ð·Ð°Ð¿Ñ€Ð¾Ñ Ðº API
            WEB->>WS: POST /api/projects/create-repository
            WS->>WS: Middleware Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°
            WS->>PROJECT: Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
            PROJECT-->>WS: Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
            WS-->>WEB: HTTP Ð¾Ñ‚Ð²ÐµÑ‚
        end
        
        alt Webhook Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°
            NETLIFY->>WS: POST /api/webhooks/netlify
            WS->>WS: ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ webhook Ð´Ð°Ð½Ð½Ñ‹Ñ…
            WS->>IO: Broadcast ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼
            WS-->>NETLIFY: 200 OK
        end
    end

    %% === Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð˜ ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“ ===
    rect rgb(255, 255, 240)
        Note over WS: ðŸ“Š Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð˜ ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“
        
        Note left of WS: Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯
        Note left of WS: â”œâ”€â”€ winston logger
        Note left of WS: â”‚   â”œâ”€â”€ Console transport (dev)
        Note left of WS: â”‚   â”œâ”€â”€ File transport (prod)
        Note left of WS: â”‚   â””â”€â”€ Error levels (error, warn, info)
        Note left of WS: â”œâ”€â”€ Structured logging (JSON)
        Note left of WS: â”œâ”€â”€ Request ID tracing
        Note left of WS: â””â”€â”€ Performance metrics

        Note right of WS: ÐœÐžÐÐ˜Ð¢ÐžÐ Ð˜ÐÐ“ Ð˜ ÐœÐ•Ð¢Ð Ð˜ÐšÐ˜
        Note right of WS: â”œâ”€â”€ Connection metrics
        Note right of WS: â”‚   â””â”€â”€ ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
        Note right of WS: â”œâ”€â”€ API metrics
        Note right of WS: â”‚   â””â”€â”€ Request/response Ð²Ñ€ÐµÐ¼Ñ
        Note right of WS: â”œâ”€â”€ GitHub API rate limits
        Note right of WS: â”œâ”€â”€ Netlify API usage
        Note right of WS: â””â”€â”€ Database query Ð²Ñ€ÐµÐ¼Ñ

        alt Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
            WS->>WS: logger.info('Project created', {projectId})
            WS->>WS: logger.error('GitHub API failed', {error})
            WS->>WS: Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ JSON Ð»Ð¾Ð³
        end
        
        alt ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
            WS->>WS: performance.mark('start')
            WS->>GITHUB: API Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
            WS->>WS: performance.mark('end')
            WS->>WS: performance.measure('github-api')
        end
    end

    %% === DEPLOYMENT Ð˜ ENVIRONMENT ===
    rect rgb(245, 255, 255)
        Note over WS: ðŸš€ DEPLOYMENT & ENVIRONMENT
        
        Note left of WS: PRODUCTION DEPLOYMENT
        Note left of WS: â”œâ”€â”€ Railway.app hosting
        Note left of WS: â”œâ”€â”€ Node.js 18+ runtime
        Note left of WS: â”œâ”€â”€ PM2 process manager
        Note left of WS: â”œâ”€â”€ Auto-scaling (CPU/Memory)
        Note left of WS: â”œâ”€â”€ Health checks
        Note left of WS: â””â”€â”€ Zero-downtime deploys

        Note right of WS: ENVIRONMENT VARIABLES
        Note right of WS: â”œâ”€â”€ PORT (8080)
        Note right of WS: â”œâ”€â”€ NODE_ENV (production/development)
        Note right of WS: â”œâ”€â”€ DATABASE_URL (Supabase)
        Note right of WS: â”œâ”€â”€ GITHUB_APP_ID
        Note right of WS: â”œâ”€â”€ GITHUB_APP_PRIVATE_KEY
        Note right of WS: â”œâ”€â”€ GITHUB_APP_INSTALLATION_ID
        Note right of WS: â”œâ”€â”€ NETLIFY_ACCESS_TOKEN
        Note right of WS: â”œâ”€â”€ R2_ENDPOINT, R2_ACCESS_KEY_ID
        Note right of WS: â”œâ”€â”€ R2_SECRET_ACCESS_KEY
        Note right of WS: â””â”€â”€ CORS_ORIGIN (Web App URL)

        alt Development Ñ€ÐµÐ¶Ð¸Ð¼
            WS->>WS: npm run dev
            WS->>WS: nodemon + TypeScript compilation
            WS->>WS: ngrok tunnel Ð´Ð»Ñ webhooks
            WS-->>AGENT: ws://localhost:8080
        end
        
        alt Production Ñ€ÐµÐ¶Ð¸Ð¼
            WS->>WS: npm run build
            WS->>WS: TypeScript â†’ JavaScript
            WS->>WS: pm2 start ecosystem.config.js
            WS-->>AGENT: wss://production-url
        end
    end